# Tool for managing features and Feature Store

This is a prototype of a CLI tool for defining, calculating and ingesting features into a Feature Store. The focus is on features calculated by a rolling time window aggregation, which are common in various ML applications, like fraud detection for example. AWS SageMaker is utilized as the service to manage the Feature Store and a DSL (domain specific language) was created to define the Feature Group (SageMaker's concept for a logical grouping of features) and the features.

## Test dataset

The dataset utilized during the tests has the schema below:

```
root
 |-- tx_id: string (nullable = true)
 |-- tx_datetime: timestamp (nullable = true)
 |-- customer_id: string (nullable = true)
 |-- terminal_id: string (nullable = true)
 |-- tx_amount: double (nullable = true)
 |-- tx_time_seconds: integer (nullable = true)
 |-- tx_time_days: integer (nullable = true)
 |-- tx_fraud: integer (nullable = true)
 |-- tx_fraud_scenario: integer (nullable = true)
 ```

## DSL

The Feature Group and its features are defined through a YAML file like the example below:

```yaml
dataset: # information about the dataset that is utilized for calculating the features
  bucket: fraud-simu-data # s3 bucket of the dataset
  prefix: historical-data # s3 prefix of the dataset
  name: transactions # name of the file (for this prototype, the file is expected to be a CSV)
feature_group: # information about the Feature Group
  name: customer # name of the Feature Group
  description: Historical behaviour of customers # a description for the Feature Group
  time_column: tx_datetime # column containing the timestamp of the event
  entity_columns: [customer_id] # columns with the entities for which the features are calculated
  windows: [3h, 1d, 10d, 30d] # time windows for singular operations (the ones that use only one window)
  cpd_windows: [[3h, 10d]] # time windows for compound operations (the ones that use two windows)
  features: # feature definitions
    - name: qty # name of the feature (it's not the final name, a sufix with information about the window and entity is added afterwards)
      description: Number of transactions made by the customer # a description for the feature
      operation: COUNT() # the operation that calculates the feature
      condition: Null # a logical expression to select the events the should be used in the calculation (Null for keeping all events)
    - name: qty_fraud
      description: Number of fradulent transactions made by the customer
      operation: COUNT()
      condition: tx_fraud = 1
    - name: amt
      description: Total amount of the transactions made by the customer
      operation: SUM(tx_amount)
      condition: Null
    - name: amt_fraud
      description: Total amount of the fraudulent transactions made by the customer
      operation: SUM(tx_amount)
      condition: tx_fraud = 1
    - name: ratio_qty
      description: Ratio of number of transactions made by the customer between 3h and 10d
      operation: RATIO(COUNT(), COUNT())
      condition: Null
```

For this prototype only 2 singular operations are implemented, SUM and COUNT, and 1 compound, RATIO (which divides the first operation by the second). 

The feature calculation is done by running a SageMaker PySpark processing job, which receives as input a SQL query generated by parsing the YAML file. After being calculated, the features are ingested into the Feature Store in the same job.

## CLI

To run the application, AWS credentials must be already configured in the machine and there must be a valid sagemaker role in the AWS account. Also the app must be installed with Poetry.

### Compile (parse) the YAML file

```bash
fstool compile <YAML_FILE_PATH>
```

### Create the Feature Group

The compilation is required to run this command.

```bash
fstool create-feat-group
```

### Calculate/Ingest features

The compilation is required to run this command.

```bash
fstool calculate-ingest-feats
```

The dataset containing the calculated features has the following schema:

```
root
 |-- customer_id: string (nullable = true)
 |-- tx_datetime: timestamp (nullable = true)
 |-- qty_3h_customer_id: long (nullable = false)
 |-- qty_1d_customer_id: long (nullable = false)
 |-- qty_10d_customer_id: long (nullable = false)
 |-- qty_30d_customer_id: long (nullable = false)
 |-- qty_fraud_3h_customer_id: long (nullable = false)
 |-- qty_fraud_1d_customer_id: long (nullable = false)
 |-- qty_fraud_10d_customer_id: long (nullable = false)
 |-- qty_fraud_30d_customer_id: long (nullable = false)
 |-- amt_3h_customer_id: double (nullable = true)
 |-- amt_1d_customer_id: double (nullable = true)
 |-- amt_10d_customer_id: double (nullable = true)
 |-- amt_30d_customer_id: double (nullable = true)
 |-- amt_fraud_3h_customer_id: double (nullable = true)
 |-- amt_fraud_1d_customer_id: double (nullable = true)
 |-- amt_fraud_10d_customer_id: double (nullable = true)
 |-- amt_fraud_30d_customer_id: double (nullable = true)
 |-- ratio_qty_3h_10d_customer_id: double (nullable = true)
```

